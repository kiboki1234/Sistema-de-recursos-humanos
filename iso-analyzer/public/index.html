<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO Compliance Dashboard v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 20px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }

        .dashboard {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center mb-5">üõ°Ô∏è ISO Compliance Dashboard v2.0 (Enhanced)</h1>

        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Analyzing project metrics... (This may take a few seconds)</p>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="row">
                <!-- Maintainability -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">ISO/IEC 25010: Maintainability</div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Maintainability Index (MI)
                                    <span id="mi-badge" class="badge rounded-pill">0</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Cyclomatic Complexity (Avg)
                                    <span id="cc-badge" class="badge rounded-pill">0</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Comment Density
                                    <span id="cd-badge" class="badge rounded-pill">0%</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Performance -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">ISO/IEC 25010: Performance Efficiency</div>
                        <div class="card-body text-center">
                            <h5>Est. Load Time (3G)</h5>
                            <div id="load-time" class="display-4 text-dark">0s</div>
                            <div class="progress mt-3" style="height: 20px;">
                                <div id="load-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-2 d-block" id="total-size">Size: 0 KB</small>
                        </div>
                    </div>
                </div>

                <!-- Process -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">ISO 29110 & 9001: Process & Documentation</div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <h6>Version Control (Git)</h6>
                                    <div id="git-status" class="alert alert-secondary">Checking...</div>
                                </div>
                                <div class="col-md-3">
                                    <h6>Documentation (README)</h6>
                                    <div id="doc-status" class="alert alert-secondary">Checking...</div>
                                </div>
                                <div class="col-md-3">
                                    <h6>Pending Tasks (TODOs)</h6>
                                    <div id="todo-status" class="alert alert-light border">0</div>
                                </div>
                                <div class="col-md-3">
                                    <h6>Reliability (Try/Catch)</h6>
                                    <div id="reli-status" class="alert alert-light border">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Quality & Security Details -->
                <div class="col-12">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-danger text-white">Top 5 Hotspots (Worst Files)</div>
                                <ul class="list-group list-group-flush" id="hotspot-list">
                                    <!-- Items injected by JS -->
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-dark text-white">ISO 27001: Security Audit</div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span>Hardcoded Secrets Detected:</span>
                                        <span id="secret-badge" class="badge bg-secondary">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span>Vulnerabilities (npm audit):</span>
                                        <span id="vuln-badge" class="badge bg-secondary">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Code Duplication:</span>
                                        <span id="dup-badge" class="badge bg-secondary">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Deep Analysis (Phase 3) -->
                <div class="col-12 mt-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <strong>Deep Quality Analysis (ISO 25010 Modularity & Efficiency)</strong>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6>Architecture Violation (Layers)</h6>
                                    <div id="layer-status" class="alert alert-secondary">Checking...</div>
                                </div>
                                <div class="col-md-4">
                                    <h6>Dead Code (Unused Files)</h6>
                                    <h2 id="dead-count" class="display-6">0</h2>
                                    <small class="text-muted">Files with 0 references</small>
                                </div>
                                <div class="col-md-4">
                                    <h6>Coupling (Dependencies)</h6>
                                    <h2 id="dep-count" class="display-6">0</h2>
                                    <small class="text-muted">Internal Links</small>
                                </div>
                            </div>
                            <!-- Details List -->
                            <div id="dead-code-list" class="mt-3 text-muted small"
                                style="max-height: 100px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <!-- NEW: Deep Analysis (Phase 3) -->
                    <div class="col-12 mt-4">
                        <div class="card border-warning">
                            <!-- ... (existing deep analysis content) ... -->
                        </div>
                    </div>

                    <!-- NEW: Gemini AI Insights (Phase 4) -->
                    <div class="col-12 mt-4">
                        <div class="card border-primary shadow-sm">
                            <div
                                class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <strong>‚ú® Intelligent Compliance Associate (Gemini AI)</strong>
                                <button id="btn-ask-ai" class="btn btn-sm btn-light" onclick="askAI()">Ask AI
                                    Consultant</button>
                            </div>
                            <div class="card-body">
                                <div id="ai-loading" class="text-center" style="display:none;">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Consulting with Gemini 1.5 Flash...</p>
                                </div>
                                <div id="ai-content" class="markdown-body">
                                    <p class="text-muted text-center">Click "Ask AI Consultant" to generate an ISO
                                        compliance strategy.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="text-center mt-4 mb-5">
                    <button onclick="loadData()" class="btn btn-outline-primary">üîÑ Re-run Analysis</button>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', loadData);

            function showLoading() {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
            }

            function showDashboard() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            }

            async function loadData() {
                showLoading();
                try {
                    const res = await fetch('/api/report');
                    const data = await res.json();
                    render(data);
                    showDashboard();
                } catch (e) {
                    alert('Analysis failed: ' + e.message);
                }
            }

            function render(data) {
                const { metrics, gitStats, perfStats, readmeExists, advanced } = data;

                // Maintainability
                const miIdx = metrics.avgMaintainability;
                const miBadge = document.getElementById('mi-badge');
                miBadge.textContent = miIdx.toFixed(2);
                miBadge.className = 'badge rounded-pill ' + (miIdx > 85 ? 'bg-success' : miIdx > 65 ? 'bg-warning text-dark' : 'bg-danger');

                const ccVal = metrics.totalComplexity / metrics.files.length;
                const ccBadge = document.getElementById('cc-badge');
                ccBadge.textContent = ccVal.toFixed(2);
                ccBadge.className = 'badge rounded-pill ' + (ccVal < 10 ? 'bg-success' : ccVal < 20 ? 'bg-warning text-dark' : 'bg-danger');

                const cdVal = (metrics.totalComments / (metrics.totalLOC + metrics.totalComments)) * 100;
                const cdBadge = document.getElementById('cd-badge');
                cdBadge.textContent = cdVal.toFixed(2) + '%';
                cdBadge.className = 'badge rounded-pill ' + (cdVal > 10 ? 'bg-success' : 'bg-warning text-dark');

                // Performance
                const time = parseFloat(perfStats.estLoadTime);
                document.getElementById('load-time').textContent = time + 's';
                document.getElementById('total-size').textContent = 'Est. Bundle Size: ' + (perfStats.totalEstSize / 1024).toFixed(2) + ' KB';

                const bar = document.getElementById('load-bar');
                bar.style.width = Math.min((time / 10) * 100, 100) + '%';
                bar.className = 'progress-bar ' + (time < 2 ? 'bg-success' : time < 5 ? 'bg-warning' : 'bg-danger');

                // Process
                const gitEl = document.getElementById('git-status');
                if (gitStats.isRepo) {
                    gitEl.className = 'alert alert-success';
                    gitEl.innerHTML = '<strong>Active</strong><br>Branch: ' + gitStats.branch + '<br>Commits: ' + gitStats.commits;
                } else {
                    gitEl.className = 'alert alert-danger';
                    gitEl.textContent = 'Not initialized';
                }

                const docEl = document.getElementById('doc-status');
                if (readmeExists) {
                    docEl.className = 'alert alert-success';
                    docEl.textContent = 'README.md Found';
                } else {
                    docEl.className = 'alert alert-danger';
                    docEl.textContent = 'Missing Documentation';
                }

                if (advanced) {
                    // Todos
                    const todoEl = document.getElementById('todo-status');
                    todoEl.textContent = advanced.todoCount + ' Found';
                    todoEl.className = 'alert ' + (advanced.todoCount > 20 ? 'alert-warning' : 'alert-success');

                    // Reliability
                    const reliEl = document.getElementById('reli-status');
                    reliEl.textContent = advanced.reliabilityDensity + ' Density';

                    // Secrets
                    const secretBadge = document.getElementById('secret-badge');
                    secretBadge.textContent = advanced.secretCount;
                    secretBadge.className = 'badge ' + (advanced.secretCount > 0 ? 'bg-danger' : 'bg-success');

                    // Vulns
                    const vulnBadge = document.getElementById('vuln-badge');
                    vulnBadge.textContent = advanced.securityAudit ? advanced.securityAudit.vulnerabilities : '0';
                    vulnBadge.className = 'badge ' + (advanced.securityAudit && advanced.securityAudit.vulnerabilities > 0 ? 'bg-danger' : 'bg-success');

                    // Duplication
                    const dupBadge = document.getElementById('dup-badge');
                    dupBadge.textContent = advanced.duplicationStats.percentage + '%';
                    dupBadge.className = 'badge ' + (advanced.duplicationStats.percentage > 5 ? 'bg-warning text-dark' : 'bg-success');

                    // Hotspots
                    const list = document.getElementById('hotspot-list');
                    list.innerHTML = '';
                    advanced.hotspots.forEach(file => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                        <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:70%;" title="${file.path}">
                            <small class="text-muted">Complexity: ${file.complexity}</small><br>
                            ${file.path}
                        </div>
                        <span class="badge bg-danger rounded-pill">MI: ${file.mi.toFixed(0)}</span>
                    `;
                        list.appendChild(li);
                    });

                    // Deep Analysis Render
                    if (advanced.deepAnalysis) {
                        // Coupling
                        document.getElementById('dep-count').textContent = advanced.deepAnalysis.dependencyCount;

                        // Layering
                        const layerEl = document.getElementById('layer-status');
                        if (advanced.deepAnalysis.layeringViolations.length > 0) {
                            layerEl.className = 'alert alert-danger';
                            layerEl.innerHTML = `<strong>${advanced.deepAnalysis.layeringViolations.length} Violations!</strong><br>Frontend imports Backend`;
                        } else {
                            layerEl.className = 'alert alert-success';
                            layerEl.textContent = 'Clean Architecture';
                        }

                        // Dead Code
                        document.getElementById('dead-count').textContent = advanced.deepAnalysis.deadCode.length;
                        const deadList = document.getElementById('dead-code-list');
                        if (advanced.deepAnalysis.deadCode.length > 0) {
                            deadList.innerHTML = '<strong>Potentially Unused:</strong><br>' + advanced.deepAnalysis.deadCode.slice(0, 10).join(', ') + (advanced.deepAnalysis.deadCode.length > 10 ? '...' : '');
                        } else {
                            deadList.innerHTML = '';
                        }
                    }
                }
            }

            async function askAI() {
                const btn = document.getElementById('btn-ask-ai');
                const loading = document.getElementById('ai-loading');
                const content = document.getElementById('ai-content');

                btn.disabled = true;
                loading.style.display = 'block';
                content.style.display = 'none';

                try {
                    const response = await fetch('/api/ai-report');
                    const data = await response.json();

                    if (data.error) {
                        if (response.status === 400) {
                            content.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>AI Feature Not Enabled</strong><br>
                                ${data.error}
                            </div>`;
                        } else {
                            content.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                        }
                    } else {
                        // Use marked.js for proper markdown rendering
                        content.innerHTML = marked.parse(data.markdown);
                    }
                } catch (err) {
                    content.innerHTML = `<div class="alert alert-danger">Connection Failed</div>`;
                } finally {
                    btn.disabled = false;
                    loading.style.display = 'none';
                    content.style.display = 'block';
                }
            }
        </script>
</body>

</html>
```